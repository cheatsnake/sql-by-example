# SQL на примерах

SQL (Structured Query Language) – это специальный язык запросов для работы с реляционными базами данных (например [MySQL](https://ru.wikipedia.org/wiki/MySQL), [PostgreSQL](https://ru.wikipedia.org/wiki/PostgreSQL), [Oracle](https://ru.wikipedia.org/wiki/Oracle_Database), [MariaDB](https://ru.wikipedia.org/wiki/MariaDB)). SQL-запросы строятся из набора операторов, которые представляют из себя обычные слова английского языка.

> Все приведенные примеры были успешно протестированы в PostgreSQL версии 15.

## Основы SQL

В данном разделе рассматриваются примеры основных операций (созданиe/получениe/изменениe/удалениe) для работы с данными в SQL-таблицах.

### Создание новой базы данных

```sql
CREATE DATABASE store;
```

В базе данных можно определять неограниченное количество таблиц в которых и будут хранится нужные данные.

> Заметьте, что каждый SQL-запрос заканчивается точкой с запятой.

### Создание таблицы

На этапе создания таблицы указываются типы данных и определяются различные атрибуты для всех столбцов.

```sql
CREATE TABLE clients (
    id SERIAL PRIMARY KEY,
    firstName VARCHAR(50) NOT NULL,
    lastName VARCHAR(50) NOT NULL,
    email VARCHAR(50) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    age SMALLINT NOT NULL,
    gender VARCHAR(6) NOT NULL,
    isMarried BOOLEAN,
    createdAt TIMESTAMP,
    updatedAt TIMESTAMP
);
```

### Типы данных

Ниже приведен список основных типов для базы данных PostgreSQL.

> В других СУБД приведенные типы данных и их описание может немного отличаться. Поэтому при возникновении ошибок обратитесь к документации.

#### Числовые типы

| Тип                         | Значения                                                              | Описание                                                                                                                                                       |
| :-------------------------- | :-------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `smallint` `int2`           | Числа от -32768 до +32767                                             | Занимает 2 байта.                                                                                                                                              |
| `integer` `int4` `int`      | Числа от -2147483648 до +2147483647                                   | Занимает 4 байта.                                                                                                                                              |
| `bigint` `int8`             | Числа от -9223372036854775808 до +9223372036854775807                 | Занимает 8 байт.                                                                                                                                               |
| `numeric` `decimal`         | Числа с целой часть до 131072 знаков и до 131072 знаков после запятой | Принимает 2 параметра precision (общее количество цифр) и scale (количество цифр после запятой). <br> _numeric(5, 3) – 22,725_ <br> _decimal(10, 1) – 52538,4_ |
| `real` `float4`             | Числа от 1E-37 до 1E+37                                               | Занимает 4 байта.                                                                                                                                              |
| `double precision` `float8` | Числа от от 1E-307 до 1E+308                                          | Занимает 8 байт.                                                                                                                                               |
| `serial`                    | Автоинкрементирующееся числовые значения от 1 до 2147483647           | Занимает 4 байта. Значение для данного типа подбираются автоматом в зависимости от значений предыдущего элемента. Отлично подходит для уникальных ID.          |
| `smallserial`               | Автоинкрементирующееся числовые значения от 1 до 32767                | Занимает 2 байта.                                                                                                                                              |
| `bigserial`                 | Автоинкрементирующееся числовые значения от 1 до 9223372036854775807  | Занимает 8 байт.                                                                                                                                               |

#### Символьные типы

| Тип                           | Значения                   | Описание                                                                                                               |
| :---------------------------- | :------------------------- | :--------------------------------------------------------------------------------------------------------------------- |
| `character` `char`            | Строки фиксированной длины | Принимает параметр, который задает количество символов в строке. <br> _char(5) – hello_                                |
| `character varying` `varchar` | Строки переменной длины    | Принимает параметр, который задает **максимальное** количество символов в строке. <br> _varchar(5) – abc, abcd, abcde_ |
| `text`                        | Текст произвольной длины   | Подойдет для хранения текста статей, отзывов, описаний.                                                                |

#### Дата и время

| Тип                        | Значения                                                                      | Описание          |
| :------------------------- | :---------------------------------------------------------------------------- | :---------------- |
| `timestamp`                | Дата и вермя от 4713 г до н.э до 294276 г н.э.                                | Занимает 8 байт.  |
| `timestamp with time zone` | Дата и вермя от 4713 г до н.э до 294276 г н.э. включая данные о часовом поясе | Занимает 8 байт.  |
| `date`                     | Дата от 4713 г. до н.э. до 5874897 г н.э.                                     | Занимает 4 байта. |
| `time`                     | Время от 00:00:00 до 24:00:00                                                 | Занимает 8 байт.  |
| `time with time zone`      | Время от 00:00:00+1459 до 24:00:00-1459.                                      | Занимает 12 байт. |

#### Геометрические типы

| Тип       | Значения                                       | Описание              |
| :-------- | :--------------------------------------------- | :-------------------- |
| `point`   | Точка формата (x,y)                            | Занимает 16 байт.     |
| `line`    | Линия в формате {A,B,C}                        | Занимает 32 байта.    |
| `lseg`    | Отрезок в формате ((x1,y1),(x2,y2))            | Занимает 32 байта.    |
| `box`     | Прямоугольник в формате ((x1,y1),(x2,y2))      | Занимает 32 байта.    |
| `path`    | Набор содиненных точек в формате ((x1,y1),...) | Занимает 16+16n байт. |
| `polygon` | Многоугольник в формате ((x1,y1),...).         | Занимает 40+16n байт. |
| `circle`  | Окружность в формате <(x,y),r>                 | Занимает 24 байта.    |

#### Другие

| Тип       | Значения                                                 | Описание                                                                                                                                            |
| :-------- | :------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------- |
| `boolean` | true / false                                             | Вместо true можно указывать следующие значения: TRUE, 't', 'true', 'y', 'yes', 'on', '1'. Вместо FALSE: FALSE, 'f', 'false', 'n', 'no', 'off', '0'. |
| `bytea`   | Данные в виде бинарных строк                             |                                                                                                                                                     |
| `json`    | JSON в текстовом виде                                    |                                                                                                                                                     |
| `jsonb`   | JSON в бинарном формате                                  |                                                                                                                                                     |
| `uuid`    | Хранит строки [UUID](https://ru.wikipedia.org/wiki/UUID) |                                                                                                                                                     |
| `xml`     | Даные в формате XML                                      |                                                                                                                                                     |

### Атрибуты

Атрибуты позволяют указать дополнительные свойства для столбцов таблицы.

-   `PRIMARY KEY` – указывает, что столбец хранит уникальный идентификатор.

```sql
CREATE TABLE test (
    id SERIAL PRIMARY KEY
);
```

-   `UNIQUE` – указывает, что каждый элемент в столбце будет уникальным.

```sql
CREATE TABLE emails (
    email VARCHAR(50) UNIQUE
);
```

-   `NULL` – указывает, что значение в столбце может отсутствовать. (По умолчанию, все столбцы, кроме `PRIMARY KEY`, допускают отсутствие значений, поэтому явно его указывать не нужно.)

-   `NOT NULL` – указывает, что значение в столбце не может быть пустым.

```sql
CREATE TABLE users (
    firstName VARCHAR(30) NOT NULL,
    lastName VARCHAR(30) NOT NULL
);
```

-   `DEFAULT` – указывает значение, которое будет присваиватся по умолчанию.

```sql
CREATE TABLE messages (
    text VARCHAR(200) DEFAULT 'Hello World'
);
```

-   `CHECK` – указывает диапазон значений, которые могут храниться в столбце.

```sql
CREATE TABLE users (
    firstName VARCHAR(50),
    age INTEGER NOT NULL CHECK(age > 0 AND age < 100)
);
```

### Добавление данных

```sql
INSERT INTO clients (firstName, lastName, age, gender, isMarried)
    VALUES ('Alex', 'Smith', 25, 'male', false);
```

Можно вставлять сразу несколько элементов, перечисляя значения для нового элемента в новых скобках:

```sql
INSERT INTO messages (title, body) VALUES
    ('MSG-1', 'Hello World'),
    ('MSG-2', 'SQL is awesome'),
    ('MSG-3', 'Have a nice day!');
```

### Выборка данных

> Помните, что многие операторы можно комбинировать друг с другом.

Получить все элементы таблицы со значениями всех её столбцов:

```sql
SELECT * FROM clients;
```

Получить все элементы таблицы со значениями определенных столбцов:

```sql
SELECT firstName, lastName, phone FROM clients;
```

Получить первые `20` элементов таблицы:

```sql
SELECT * FROM clients LIMIT 20;
```

Получить первые `10` элементов таблицы начиная с позиции `50` (пагинация):

```sql
SELECT * FROM clients LIMIT 10 OFFSET 50;
```

Получить все элементы, где столбец `gender` равен значению "male":

```sql
SELECT * FROM clients WHERE gender = 'male';
```

Получить все элементы, где столбец `age` равен 25 и столбец `isMarried` равен false:

```sql
SELECT * FROM clients WHERE age = 25 AND isMarried = false;
```

Получить все элементы, где столбец `firstName` равен "Alex" или столбец `lastName` равен "Smith":

```sql
SELECT * FROM clients WHERE firstName = 'Alex' OR lastName = 'Smith';
```

Получить все элементы таблицы, где столбец `firstName` может иметь одно из перечисленных значений: "John", "Mike", "Kane":

```sql
SELECT * FROM clients WHERE firstName IN ('John', 'Mike', 'Kane');
```

Получить все элементы, где значения столбца `age` находятся в диапазоне от 20 до 30:

```sql
SELECT * FROM clients WHERE age BETWEEN 20 AND 30;
```

Получить все элементы, где значения столбца `phone` не являются пустыми:

```sql
SELECT * FROM clients WHERE phone IS NOT NULL;
```

Получить все значения столбца `lastName` без повторений (то есть, только уникальные значения):

```sql
SELECT DISTINCT(lastName) FROM clients;
```

### Поиск данных по шаблону

Для поиска данных по шаблонам используются операторы `LIKE` и `NOT LIKE`.
В самих шаблонах использются специальные подстановочные знаки:

-   `%` – подстановочный знак, который указывает, что на его месте может быть любое кол-во символов.
-   `_` – подстановочный знак, который указывает, что на его месте может быть только один символ.

Получить все элементы таблицы, где значение столбца `firstName` начинается с символа "A":

```sql
SELECT * FROM clients WHERE firstName LIKE 'A%';
```

Получить все элементы таблицы, где значение столбца `firstName` начинается с одного из перечисленных символов: "A", "B", "C":

```sql
SELECT * FROM clients WHERE firstName LIKE '[ABC]%';
```

Получить все элементы таблицы, где 2-ой символ в значении столбца `firstName` не равен символу "o":

```sql
SELECT * FROM clients WHERE firstName NOT LIKE '_o%';
```

### Сортировка и фильтрация

### Изменение данных

### Удаление данных

### Псевдонимы

### Изменение таблиц

### Агрегатные функции

Агрегатные (_aggregate – совокупный_) функции используются для обобщения/подсчета данных.
